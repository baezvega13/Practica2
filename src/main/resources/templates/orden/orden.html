<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Orden</title>
        <link rel="stylesheet" th:href="@{/css/orden.css}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <script th:src="@{/js/cart-service.js}"></script>
    </head>
    <body>
        <div class="main-container">
            <header th:replace="~{orden/fragmentos :: headerOrden(titulo='ORDEN', backUrl='/catalogo')}"></header>

            <div class="order-container">
                <div class="order-header">
                    <span class="header-product">Producto</span>
                    <span class="header-quantity">Cantidad</span>
                    <span class="header-price-unit">Precio</span>
                    <span class="header-total">Total</span>
                </div>

                <div id="orderItemsContainer" class="order-items-list">
                </div>

                <div class="order-summary-total">
                    <span class="total-label">TOTAL</span>
                    <span id="grandTotalValue" class="total-value">₡0,00</span>
                </div>

                <div class="order-summary-actions">
                    <button id="cancelOrderButton" class="cancel-button">CANCELAR PEDIDO</button>
                    <button id="confirmOrderButton" class="confirm-button">CONFIRMAR PEDIDO</button>
                </div>
            </div>

            <footer th:replace="~{orden/fragmentos :: footerOrden}"></footer>
        </div>

        <div id="alertModal" class="modal-overlay">
            <div class="modal-dialog">
                <div class="modal-content-alert">
                    <h3 id="alertModalTitle" class="modal-title"></h3>
                    <p id="alertModalMessage" class="modal-message"></p>
                    <button id="alertModalCloseButton" class="modal-close-button">Aceptar</button>
                </div>
            </div>
        </div>

        <script>
            let order = [];

            document.addEventListener('DOMContentLoaded', function () {
                order = window.cart.get();

                renderOrder();

                document.getElementById('cancelOrderButton').addEventListener('click', cancelOrder);
                document.getElementById('confirmOrderButton').addEventListener('click', confirmOrder);
                document.getElementById('alertModalCloseButton').addEventListener('click', closeAlertModal);
            });

            function renderOrder() {
                const container = document.getElementById('orderItemsContainer');
                container.innerHTML = '';
                let grandTotal = 0;

                if (order.length === 0) {
                    container.innerHTML = '<p class="empty-order-message">Tu orden está vacía. Añade productos desde el catálogo.</p>';
                } else {
                    order.forEach(item => {
                        const itemTotal = item.quantity * item.price;
                        grandTotal += itemTotal;

                        const orderItemDiv = document.createElement('div');
                        orderItemDiv.classList.add('order-item');
                        orderItemDiv.dataset.productId = item.id;

                        orderItemDiv.innerHTML = `
                            <i class="fas fa-trash trash-icon"></i>
                            <span class="order-item-product-name">${item.name}</span>
                            <div class="quantity-controls">
                                <i class="fas fa-minus quantity-minus"></i>
                                <span class="quantity-number">${item.quantity}</span>
                                <i class="fas fa-plus quantity-plus"></i>
                            </div>
                            <span class="price-per-unit">₡${item.price.toLocaleString('es-CR', {minimumFractionDigits: 2})}</span>
                            <span class="total-price">₡${itemTotal.toLocaleString('es-CR', {minimumFractionDigits: 2})}</span>
                        `;
                        container.appendChild(orderItemDiv);
                    });
                }

                document.getElementById('grandTotalValue').textContent = `₡${grandTotal.toLocaleString('es-CR', {minimumFractionDigits: 2})}`;

                document.querySelectorAll('.trash-icon').forEach(icon => {
                    icon.addEventListener('click', function () {
                        const productId = parseInt(this.closest('.order-item').dataset.productId);
                        removeItemFromOrder(productId);
                    });
                });

                document.querySelectorAll('.quantity-minus').forEach(icon => {
                    icon.addEventListener('click', function () {
                        const productId = parseInt(this.closest('.order-item').dataset.productId);
                        updateQuantity(productId, -1);
                    });
                });

                document.querySelectorAll('.quantity-plus').forEach(icon => {
                    icon.addEventListener('click', function () {
                        const productId = parseInt(this.closest('.order-item').dataset.productId);
                        updateQuantity(productId, 1);
                    });
                });
            }

            function removeItemFromOrder(productId) {
                window.cart.remove(productId);
                order = window.cart.get();
                renderOrder();
                showAlertModal('Producto Eliminado', 'El producto ha sido eliminado de tu orden.');
            }

            function updateQuantity(productId, delta) {
                const productInAllProducts = getProductDetailsFromAllProducts(productId);
                const maxStock = productInAllProducts ? productInAllProducts.stock : 999;

                let currentItem = order.find(item => item.id === productId);
                if (currentItem) {
                    let newQuantity = currentItem.quantity + delta;
                    if (newQuantity < 1)
                        newQuantity = 1;

                    if (newQuantity > maxStock) {
                        showAlertModal('Stock Limitado', `No puedes añadir más de ${maxStock} unidades de este producto.`);
                        newQuantity = maxStock;
                    }

                    window.cart.updateQuantity(productId, newQuantity - currentItem.quantity);
                    order = window.cart.get();
                    renderOrder();
                }
            }

            function cancelOrder() {
                window.cart.clear();
                order = [];
                renderOrder();
                showAlertModal('Pedido Cancelado', 'Tu orden ha sido cancelada y vaciada.');
            }

            function confirmOrder() {
                if (order.length === 0) {
                    showAlertModal('Orden Vacía', 'No puedes confirmar un pedido vacío.');
                    return;
                }

                const orderNumber = Math.floor(Math.random() * 1000000);
                showAlertModal(
                        '¡Pedido Confirmado!',
                        `Tu pedido ha sido procesado. Número de retiro: <strong>${orderNumber}</strong>. Te esperamos pronto.`
                        );
                window.cart.clear();
                order = [];
                renderOrder();
            }

            function saveOrder() {
                window.cart.save(order);
            }

            function showAlertModal(title, message) {
                document.getElementById('alertModalTitle').innerHTML = title;
                document.getElementById('alertModalMessage').innerHTML = message;
                document.getElementById('alertModal').style.display = 'flex';
            }

            function closeAlertModal() {
                document.getElementById('alertModal').style.display = 'none';
            }

            function getProductDetailsFromAllProducts(productId) {
                const allAvailableProducts = [
                    {id: 1, nombre: 'Panes rústicos', categoria: 'Panadería', descripcion: 'Una selección de panes rústicos', detalle: 'Panes artesanales hechos con masa madre y horneados en piedra, perfectos para cualquier comida. Ingredientes: Harina, agua, sal, levadura. Preparación: Fermentación lenta y horneado en horno de piedra. Calorías: 250 kcal/100g.', precio: 1500.00, rutaImagen: 'pan 1.jpeg', stock: 10, activo: true},
                    {id: 2, nombre: 'Baguette', categoria: 'Panadería', descripcion: 'Crujiente y tradicional baguette', detalle: 'Pan francés clásico, crujiente por fuera y suave por dentro, ideal para sándwiches o para acompañar sopas y quesos. Ingredientes: Harina de trigo, agua, levadura, sal. Preparación: Amasado tradicional y cocción al vapor. Calorías: 280 kcal/100g.', precio: 1200.00, rutaImagen: 'pan 2.jpeg', stock: 15, activo: true},
                    {id: 3, nombre: 'Pan de barra', categoria: 'Panadería', descripcion: 'Pan de barra suave y esponjoso', detalle: 'Pan de barra grande, ideal para toda la familia, con una corteza dorada y un interior suave. Ingredientes: Harina, leche, mantequilla, azúcar, levadura, sal. Preparación: Doble fermentación y horneado suave. Calorías: 260 kcal/100g.', precio: 2100.00, rutaImagen: 'pan 3.jpeg', stock: 8, activo: true},
                    {id: 4, nombre: 'Pan artesanal', categoria: 'Panadería', descripcion: 'Hecho a mano con los mejores ingredientes', detalle: 'Pan de campo con una corteza gruesa y una miga densa, lleno de sabor. Ingredientes: Harina integral, masa madre, agua, sal. Preparación: Larga fermentación natural. Calorías: 240 kcal/100g.', precio: 2500.00, rutaImagen: 'pan 4.jpeg', stock: 7, activo: true},
                    {id: 5, nombre: 'Rollos de pan', categoria: 'Panadería', descripcion: 'Rollos individuales de pan fresco', detalle: 'Pequeños y suaves rollos, perfectos para cenas, bocadillos o para acompañar guisos. Ingredientes: Harina, huevo, leche, mantequilla, levadura. Preparación: Rellenos de queso y horneados hasta dorar. Calorías: 290 kcal/100g.', precio: 1800.00, rutaImagen: 'pan 5.jpeg', stock: 20, activo: true},
                    {id: 6, nombre: 'Pan de Viena', categoria: 'Panadería', descripcion: 'Pan de Viena, ligero y tierno', detalle: 'Con una textura delicada y un sabor ligeramente dulce, ideal para tostadas o sandwiches. Ingredientes: Harina, huevos, azúcar, leche, vainilla, levadura. Preparación: Masa enriquecida y horneado lento. Calorías: 310 kcal/100g.', precio: 1600.00, rutaImagen: 'pan 6.jpeg', stock: 12, activo: true},
                    {id: 7, nombre: 'Pastel de chocolate', categoria: 'Repostería', descripcion: 'Delicioso pastel de chocolate', detalle: 'Pastel de chocolate rico y húmedo con una suave cobertura de ganache de chocolate, perfecto para los amantes del cacao. Ingredientes: Chocolate amargo, harina, azúcar, huevos, crema. Preparación: Varias capas y cobertura de ganache. Calorías: 450 kcal/100g.', precio: 3500.00, rutaImagen: 'pastel 1.jpeg', stock: 5, activo: true},
                    {id: 8, nombre: 'Pastel de vainilla', categoria: 'Repostería', descripcion: 'Clásico pastel de vainilla', detalle: 'Pastel de vainilla esponjoso con crema de mantequilla, un postre clásico que siempre agrada. Ingredientes: Vainilla natural, harina, azúcar, huevos, mantequilla. Preparación: Bizcocho esponjoso con crema de vainilla. Calorías: 400 kcal/100g.', precio: 3200.00, rutaImagen: 'pastel 2.jpg', stock: 6, activo: true},
                    {id: 9, nombre: 'Pastel de fresa', categoria: 'Repostería', descripcion: 'Pastel con fresas frescas', detalle: 'Pastel ligero con capas de crema batida y fresas frescas, una opción refrescante y deliciosa. Ingredientes: Fresas frescas, nata, azúcar, bizcocho de vainilla. Preparación: Capas de bizcocho y crema con fresas. Calorías: 380 kcal/100g.', precio: 3100.00, rutaImagen: 'pastel 3.jpg', stock: 4, activo: true},
                    {id: 10, nombre: 'Cheesecake', categoria: 'Repostería', descripcion: 'Cheesecake cremoso', detalle: 'Pastel de queso cremoso sobre una base de galleta, con un toque de acidez que lo hace irresistible. Ingredientes: Queso crema, galletas, mantequilla, azúcar, huevos. Preparación: Horneado lento y refrigeración. Calorías: 420 kcal/100g.', precio: 4000.00, rutaImagen: 'pastel 4.jpeg', stock: 3, activo: true},
                    {id: 11, nombre: 'Tiramisú', categoria: 'Repostería', descripcion: 'Tiramisú tradicional', detalle: 'Postre italiano clásico con capas de bizcochos de soletilla empapados en café y crema de mascarpone. Ingredientes: Café, licor, huevos, azúcar, mascarpone, bizcochos. Preparación: Sin horno, refrigerado. Calorías: 410 kcal/100g.', precio: 2800.00, rutaImagen: 'pastel 5.jpeg', stock: 8, activo: true},
                    {id: 12, nombre: 'Mousse de limón', categoria: 'Repostería', descripcion: 'Mousse de limón, ligero y refrescante', detalle: 'Postre suave y aireado con un intenso sabor a limón, ideal para terminar una comida ligera. Ingredientes: Zumo de limón, nata, azúcar, gelatina. Preparación: Refrigere hasta que cuaje. Calorías: 300 kcal/100g.', precio: 2500.00, rutaImagen: 'pastel 6.jpg', stock: 7, activo: true}
                ];
                return allAvailableProducts.find(product => product.id === productId);
            }
        </script>
    </body>
</html>
